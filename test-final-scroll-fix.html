<!DOCTYPE html>
<html>
<head>
    <title>JSON2Table - Final Scroll Fix Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        .test-button:hover {
            background: #45a049;
        }
        .expand-button {
            background: #2196F3;
        }
        .expand-button:hover {
            background: #1976D2;
        }
        .collapse-button {
            background: #FF9800;
        }
        .collapse-button:hover {
            background: #F57C00;
        }
        .instructions {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #4CAF50;
            margin-bottom: 20px;
        }
        .feature-list {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .feature-list h3 {
            color: #333;
            margin-top: 0;
        }
        .feature-list ul {
            padding-left: 20px;
        }
        .feature-list li {
            margin-bottom: 8px;
            line-height: 1.4;
        }
        .highlight {
            background: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸš€ JSON2Table - Final Scroll Fix Verification</h1>
        <p>This test verifies that the jumpy scrolling behavior has been completely fixed.</p>
    </div>

    <div class="instructions">
        <h3>ðŸ§ª Test Instructions:</h3>
        <ol>
            <li><strong>Click "Show JSON Table"</strong> to open the table viewer</li>
            <li><strong>Scroll down to around row 100-200</strong> (middle of the table)</li>
            <li><strong>Click on array badges [+] to expand arrays</strong> - scroll should stay stable</li>
            <li><strong>Continue scrolling</strong> - should be smooth with no jumping</li>
            <li><strong>Expand more arrays</strong> - position should be preserved</li>
            <li><strong>Click "Expand All"</strong> - should preserve scroll position</li>
            <li><strong>Scroll after expansion</strong> - should be butter smooth</li>
            <li><strong>Click "Collapse All"</strong> - should preserve scroll position</li>
        </ol>
    </div>

    <div style="text-align: center; margin: 20px 0;">
        <button id="showTable" class="test-button">ðŸ“Š Show JSON Table</button>
        <button id="expandAll" class="test-button expand-button" style="display: none;">ðŸ“ˆ Expand All</button>
        <button id="collapseAll" class="test-button collapse-button" style="display: none;">ðŸ“‰ Collapse All</button>
    </div>

    <div class="feature-list">
        <h3>âœ… Fixed Issues:</h3>
        <ul>
            <li><span class="highlight">Jumpy Scrolling</span> - Virtual scrolling now uses accurate variable row heights</li>
            <li><span class="highlight">Header Overlap</span> - Table header stays fixed with proper z-index and background</li>
            <li><span class="highlight">Scroll Position Loss</span> - Expanding/collapsing preserves current scroll position</li>
            <li><span class="highlight">Smooth Performance</span> - 60fps scrolling with requestAnimationFrame</li>
            <li><span class="highlight">Accurate Calculations</span> - Height calculations account for expanded content</li>
        </ul>

        <h3>ðŸ”§ Technical Improvements:</h3>
        <ul>
            <li><strong>Dynamic Height Calculation:</strong> Accounts for expanded arrays (up to 200px) and objects (up to 150px)</li>
            <li><strong>Variable Row Heights:</strong> Each row height calculated based on content expansions</li>
            <li><strong>RAF Scroll Handler:</strong> Uses requestAnimationFrame for smooth 60fps scrolling</li>
            <li><strong>Proper Event Management:</strong> Bound handlers with cleanup to prevent memory leaks</li>
            <li><strong>Scroll Position Preservation:</strong> Maintains scroll position during content changes</li>
            <li><strong>Enhanced Header:</strong> Z-index 1000, theme-aware background, subtle shadow</li>
        </ul>
    </div>

    <script>
        // Generate large test dataset with mixed content
        function generateTestData() {
            const data = [];
            const categories = ['Electronics', 'Books', 'Clothing', 'Sports', 'Home', 'Auto'];
            const statuses = ['active', 'pending', 'completed', 'cancelled'];
            
            for (let i = 0; i < 500; i++) {
                const item = {
                    id: i + 1,
                    name: `Item ${i + 1}`,
                    category: categories[Math.floor(Math.random() * categories.length)],
                    price: Math.floor(Math.random() * 1000) + 10,
                    status: statuses[Math.floor(Math.random() * statuses.length)],
                    description: `This is a description for item ${i + 1}. It contains some detailed information about the product.`,
                    
                    // Arrays of varying sizes for expansion testing
                    tags: Array.from({length: Math.floor(Math.random() * 8) + 2}, (_, idx) => `tag${idx + 1}`),
                    
                    reviews: Array.from({length: Math.floor(Math.random() * 12) + 1}, (_, idx) => ({
                        reviewer: `User${idx + 1}`,
                        rating: Math.floor(Math.random() * 5) + 1,
                        comment: `This is review ${idx + 1} for item ${i + 1}`,
                        date: `2024-${String(Math.floor(Math.random() * 12) + 1).padStart(2, '0')}-${String(Math.floor(Math.random() * 28) + 1).padStart(2, '0')}`
                    })),
                    
                    variants: Array.from({length: Math.floor(Math.random() * 6) + 1}, (_, idx) => ({
                        color: ['red', 'blue', 'green', 'yellow', 'black', 'white'][idx % 6],
                        size: ['XS', 'S', 'M', 'L', 'XL'][Math.floor(Math.random() * 5)],
                        stock: Math.floor(Math.random() * 100),
                        price: Math.floor(Math.random() * 50) + 10
                    })),
                    
                    // Objects for expansion testing
                    supplier: {
                        name: `Supplier ${Math.floor(Math.random() * 20) + 1}`,
                        contact: `contact${Math.floor(Math.random() * 20) + 1}@supplier.com`,
                        phone: `+1-555-${String(Math.floor(Math.random() * 9000) + 1000)}`,
                        address: `${Math.floor(Math.random() * 9999) + 1} Supplier St, City ${Math.floor(Math.random() * 50) + 1}`,
                        rating: (Math.random() * 5).toFixed(1)
                    },
                    
                    metadata: {
                        created: `2024-${String(Math.floor(Math.random() * 12) + 1).padStart(2, '0')}-${String(Math.floor(Math.random() * 28) + 1).padStart(2, '0')}`,
                        lastModified: `2024-${String(Math.floor(Math.random() * 12) + 1).padStart(2, '0')}-${String(Math.floor(Math.random() * 28) + 1).padStart(2, '0')}`,
                        views: Math.floor(Math.random() * 10000),
                        featured: Math.random() > 0.7,
                        weight: `${(Math.random() * 10).toFixed(2)} lbs`,
                        dimensions: {
                            length: `${(Math.random() * 50).toFixed(1)} cm`,
                            width: `${(Math.random() * 50).toFixed(1)} cm`,
                            height: `${(Math.random() * 50).toFixed(1)} cm`
                        }
                    }
                };
                
                data.push(item);
            }
            
            return data;
        }

        document.getElementById('showTable').addEventListener('click', function() {
            const data = generateTestData();
            console.log('Generated test data:', data.length, 'items');
            
            // Simulate the extension's table viewer
            if (typeof showTableViewer === 'function') {
                showTableViewer(data);
                document.getElementById('expandAll').style.display = 'inline-block';
                document.getElementById('collapseAll').style.display = 'inline-block';
                this.textContent = 'ðŸ”„ Regenerate Data';
            } else {
                alert('JSON2Table extension not loaded. Please load the extension first.');
            }
        });

        document.getElementById('expandAll').addEventListener('click', function() {
            // Find expand all button in the table viewer
            const expandButton = document.getElementById('json2table-expand-all');
            if (expandButton) {
                expandButton.click();
            }
        });

        document.getElementById('collapseAll').addEventListener('click', function() {
            // Find collapse all button in the table viewer
            const collapseButton = document.getElementById('json2table-collapse-all');
            if (collapseButton) {
                collapseButton.click();
            }
        });

        // Load the content script
        const script = document.createElement('script');
        script.src = 'content.js';
        document.head.appendChild(script);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test: No PRE Element Interference</title>
    <style>
        /* Simulate typical API response page with PRE styling that could interfere */
        body {
            margin: 0;
            padding: 20px;
            font-family: monospace;
            background: #f8f9fa;
            overflow-x: auto;
            height: 100vh;
        }
        
        pre {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 20px;
            overflow: auto; /* This is the problematic scrollbar */
            max-height: 80vh;
            white-space: pre-wrap;
            word-wrap: break-word;
            /* These styles could interfere */
            position: relative;
            z-index: 999;
        }
        
        .header {
            background: #343a40;
            color: white;
            padding: 10px 20px;
            margin: -20px -20px 20px -20px;
            position: sticky;
            top: 0;
        }
        
        /* Additional problematic styles */
        html {
            height: 100%;
            overflow-y: scroll; /* This could conflict */
        }
        
        /* Style that might stick around */
        * {
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>API Response Test - PRE Element Interference</h1>
        <p>This tests that the original PRE element with all its CSS is completely removed</p>
    </div>
    
    <h2>JSON Data (This PRE should be completely removed):</h2>
    
    <pre id="test-pre" data-some-attribute="test">[
  {
    "id": 1,
    "title": "Product A with very long title that might cause overflow issues",
    "category": "Electronics",
    "price": 299.99,
    "description": "This is a very long description that might cause text wrapping and overflow issues in the original pre element which should be completely removed when converted to table view",
    "inStock": true,
    "tags": ["popular", "tech", "gadget", "electronics", "mobile"],
    "specifications": {
      "weight": "1.2 kg",
      "dimensions": "20x15x5 cm",
      "color": "Black",
      "warranty": "2 years",
      "material": "Premium aluminum alloy",
      "waterproof": true
    },
    "reviews": [
      {
        "id": 1,
        "rating": 5,
        "comment": "Excellent product! Really love the build quality and features.",
        "reviewer": "John Doe",
        "date": "2024-01-15",
        "helpful": 25,
        "verified": true
      },
      {
        "id": 2,
        "rating": 4,
        "comment": "Good value for money, delivery was fast",
        "reviewer": "Jane Smith",
        "date": "2024-01-20",
        "helpful": 18,
        "verified": true
      },
      {
        "id": 3,
        "rating": 5,
        "comment": "Amazing product, exceeded expectations!",
        "reviewer": "Mike Johnson",
        "date": "2024-01-22",
        "helpful": 32,
        "verified": false
      }
    ]
  },
  {
    "id": 2,
    "title": "Product B",
    "category": "Clothing",
    "price": 49.99,
    "description": "Comfortable and stylish clothing item",
    "inStock": false,
    "tags": ["fashion", "casual", "comfortable"],
    "specifications": {
      "material": "Cotton blend",
      "size": "M",
      "color": "Blue",
      "care": "Machine wash cold",
      "origin": "Made in USA"
    },
    "reviews": [
      {
        "id": 4,
        "rating": 3,
        "comment": "Average quality, fits well but fabric could be better",
        "reviewer": "Bob Wilson",
        "date": "2024-01-18",
        "helpful": 12,
        "verified": true
      },
      {
        "id": 5,
        "rating": 4,
        "comment": "Nice design and comfortable to wear",
        "reviewer": "Sarah Brown",
        "date": "2024-01-25",
        "helpful": 8,
        "verified": true
      }
    ]
  }
]</pre>

    <script src="content.js"></script>
    <script>
        // Enable auto-convert for testing
        chrome = {
            storage: {
                local: {
                    get: (keys, callback) => {
                        callback({
                            autoConvert: true,
                            themeOverride: 'system'
                        });
                    }
                }
            }
        };

        // Test the complete removal of PRE element
        document.addEventListener('DOMContentLoaded', () => {
            console.log('=== TESTING PRE ELEMENT REMOVAL ===');
            
            // Check initial state
            const initialPre = document.querySelector('pre');
            console.log('Before conversion:');
            console.log('- PRE element exists:', !!initialPre);
            console.log('- PRE element ID:', initialPre?.id);
            console.log('- PRE element attributes:', initialPre?.attributes.length);
            console.log('- PRE element styles:', getComputedStyle(initialPre || document.body).overflow);
            console.log('- Total body children:', document.body.children.length);
            console.log('- Body HTML length:', document.body.innerHTML.length);
            
            setTimeout(() => {
                AutoJSONDetector.checkAndConvert().then(result => {
                    console.log('\n=== CONVERSION RESULT ===');
                    console.log('Conversion result:', result);
                    
                    if (result.converted) {
                        console.log('\nAfter conversion:');
                        console.log('- PRE elements in DOM:', document.querySelectorAll('pre').length);
                        console.log('- Elements with data-attributes:', document.querySelectorAll('[data-some-attribute]').length);
                        console.log('- Total body children:', document.body.children.length);
                        console.log('- Body HTML length:', document.body.innerHTML.length);
                        console.log('- Document scroll height:', document.documentElement.scrollHeight);
                        console.log('- Body scroll height:', document.body.scrollHeight);
                        console.log('- Body overflow:', getComputedStyle(document.body).overflow);
                        console.log('- HTML overflow:', getComputedStyle(document.documentElement).overflow);
                        
                        // Check what's in the DOM now
                        console.log('\n=== DOM STRUCTURE ===');
                        console.log('Body children:');
                        Array.from(document.body.children).forEach((child, index) => {
                            console.log(`  ${index}: ${child.tagName}#${child.id || 'no-id'}.${child.className || 'no-class'} (hidden: ${child.hidden})`);
                        });
                        
                        // Test switching to raw view to see if it's clean
                        setTimeout(() => {
                            console.log('\n=== TESTING RAW VIEW ===');
                            const rawButton = document.querySelector('button:contains("Raw JSON")') || 
                                            Array.from(document.querySelectorAll('button')).find(b => b.textContent.includes('Raw'));
                            if (rawButton) {
                                rawButton.click();
                                console.log('Switched to raw view');
                                console.log('- PRE elements after raw switch:', document.querySelectorAll('pre').length);
                                console.log('- Raw container content type:', typeof document.getElementById('json2tableRaw')?.textContent);
                                console.log('- Raw container has textContent:', !!document.getElementById('json2tableRaw')?.textContent);
                                console.log('- Raw container has children:', document.getElementById('json2tableRaw')?.children.length);
                            }
                        }, 1000);
                    }
                });
            }, 500);
        });
    </script>
</body>
</html>

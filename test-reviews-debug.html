<!DOCTYPE html>
<html>
<head>
    <title>Reviews Debug Test</title>
</head>
<body>
    <h1>Reviews Array Debug Test</h1>
    <pre id="json-data">[
  {
    "id": 1,
    "name": "Test Product",
    "reviews": [
      {
        "rating": 5,
        "comment": "Excellent product!",
        "reviewer": "John Doe",
        "date": "2023-10-15T10:30:00Z"
      },
      {
        "rating": 4,
        "comment": "Very good, but could be better",
        "reviewer": "Jane Smith",
        "date": "2023-10-14T14:20:00Z"
      },
      {
        "rating": 3,
        "comment": "Average quality",
        "reviewer": "Bob Johnson",
        "date": "2023-10-13T09:15:00Z"
      }
    ]
  }
]</pre>

    <button onclick="test()">Convert to Table</button>
    <button onclick="debugExpansion()">Debug Expansion</button>
    
    <div id="debug-output"></div>

    <script>
        function test() {
            const jsonText = document.getElementById('json-data').textContent;
            try {
                const data = JSON.parse(jsonText);
                console.log('Parsed data:', data);
                
                if (window.TableViewer) {
                    window.TableViewer.convertElement(document.getElementById('json-data'));
                } else {
                    console.log('TableViewer not loaded');
                }
            } catch (e) {
                console.error('JSON parse error:', e);
            }
        }

        function debugExpansion() {
            const reviews = [
                {
                    "rating": 5,
                    "comment": "Excellent product!",
                    "reviewer": "John Doe",
                    "date": "2023-10-15T10:30:00Z"
                },
                {
                    "rating": 4,
                    "comment": "Very good, but could be better",
                    "reviewer": "Jane Smith",
                    "date": "2023-10-14T14:20:00Z"
                }
            ];

            console.log('Reviews array:', reviews);
            console.log('Array length:', reviews.length);
            console.log('First item keys:', Object.keys(reviews[0]));
            
            // Test getArrayColumns logic
            const columnSet = new Set();
            const columnPriority = new Map();
            
            reviews.forEach((item, index) => {
                if (typeof item === 'object' && item !== null) {
                    Object.keys(item).forEach(key => {
                        columnSet.add(key);
                        columnPriority.set(key, (columnPriority.get(key) || 0) + 1);
                    });
                }
            });

            const columns = Array.from(columnSet).sort((a, b) => {
                const priorityFields = ['id', 'name', 'title', 'rating', 'comment', 'date', 'price', 'description'];
                const aPriority = priorityFields.indexOf(a.toLowerCase());
                const bPriority = priorityFields.indexOf(b.toLowerCase());
                
                if (aPriority !== -1 && bPriority !== -1) {
                    return aPriority - bPriority;
                }
                if (aPriority !== -1) return -1;
                if (bPriority !== -1) return 1;
                
                const aFreq = columnPriority.get(a) || 0;
                const bFreq = columnPriority.get(b) || 0;
                
                return bFreq - aFreq;
            });

            console.log('Detected columns:', columns);
            
            // Test HTML generation
            const html = reviews.map((item, itemIndex) => {
                return `<div class="inline-array-row">
                  <span class="inline-item-index">${itemIndex + 1}.</span>
                  ${columns.map(acol => {
                    const cellValue = item[acol];
                    if (cellValue !== undefined) {
                        return `<span class="inline-property"><strong>${acol}:</strong> ${cellValue}</span>`;
                    }
                    return '';
                  }).filter(Boolean).join(', ')}
                </div>`;
            }).join('');

            document.getElementById('debug-output').innerHTML = `
                <h3>Debug Results:</h3>
                <p><strong>Columns:</strong> ${columns.join(', ')}</p>
                <div style="border: 1px solid #ccc; padding: 10px; margin: 10px 0;">
                    <strong>Generated HTML:</strong>
                    <div>${html}</div>
                </div>
                <div style="border: 1px solid #ccc; padding: 10px; margin: 10px 0;">
                    <strong>Raw HTML:</strong>
                    <pre>${html}</pre>
                </div>
            `;
        }
    </script>
</body>
</html>
